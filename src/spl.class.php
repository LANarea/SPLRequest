<?php
namespace LANarea;

/**
 * Studio Playlist Request Class
 *
 * @author Ken Verhaegen <contact@kenverhaegen.be>
 * @copyright 2014 LANarea
 * @license BSD-3-Clause
 */
class SPLRequest
{
	
	private $server_ip = null;
	private $server_port = null;

	public function __construct($server_ip,$server_port)
	{
		$this->setIp($server_ip);
		$this->setPort($server_port);
	}
	
	public function search($s)
	{
		return $this->doQuery('Search='.$s);
	}
	
	public function getAllSongs()
	{
		return $this->search('*'); // Simple, huh?
	}
	
	public function getRequests()
	{
		return $this->doQuery('List requests');
	}
	
	public function setIp((string)$server_ip)
	{
		$this->server_ip = $server_ip;
		return true;
	}
	
	public function setPort((int)$server_port)
	{
		$this->server_port = $server_port;
		return true;
	}
	
	private function doQuery($command=null)
	{
		if(NULL !== $command) {
			$command .= "\r\n"; // Adding the vital NewLine to the given command
			$fp      = fsockopen($this->server_ip, $this->server_port, $errno, $errstr, 10);
			if ($fp !== false) {
				fwrite($fp, $command);
				$buffer = trim(fgets($fp));
				while (!empty($buffer) && ($buffer != "OK")) {
					$data[] = $buffer;
					$buffer = trim(fgets($fp));
				}
				fclose($fp);
			} else {
				throw new SPLRequestException('SPLRequest Error\r\n'.$errno.': '.$errstr.'\r\n');
			}
		} else {
			throw new SPLRequestException('No valid command given.');
		}
		return $data;
	}

}

/**
 * An exception generated by SPLRequest.
 */
class SPLRequestException extends \Exception
{
}