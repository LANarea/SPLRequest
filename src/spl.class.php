<?php
namespace LANarea;

/**
 * Studio Playlist Request Class
 *
 * @author Ken Verhaegen <contact@kenverhaegen.be>
 * @copyright 2014 LANarea
 * @license BSD-3-Clause
 */
class SPLRequest
{
    
    private $server_ip = NULL;
    private $server_port = NULL;
    
    public function __construct($server_ip, $server_port)
    {
        $this->setIp($server_ip);
        $this->setPort($server_port);
    }
    
    public function getAllSongs()
    {
        return $this->search('*'); // Simple, huh?
    }
    
    public function search($s)
    {
        return $this->processSongs($this->doQuery('Search=' . $s, 'Not Found'));
    }
    
    private function processSongs($songs)
    {
        if(!is_array($songs)) return $songs;
    
        $newList = array();
        
        for ($i = 0; $i < count($songs); $i++)
        {
            if (empty($songs[$i]))
                continue;
            list($artist, $title, $filepath) = explode("|", $songs[$i]);
            $newList[] = array(
                'artist' => trim($artist),
                'title' => trim($title),
                'filepath' => trim($filepath)
            );
        }
        return $newList;
    }
    
    public function getRequests()
    {
        return $this->processRequests($this->doQuery('List requests', 'OK'));
    }
    
    private function processRequests($requests)
    {
        $newList = array();
        
        for ($i = 0; $i < count($requests); $i++)
        {
            if (empty($requests[$i]))
                continue;
            list($timestamp, $artist, $title) = explode("|", $requests[$i]);
            $newList[] = array(
                'ts' => trim($timestamp),
                'artist' => trim($artist),
                'title' => trim($title)
            );
        }
        return $newList;
    }
    
    public function doRequest($filepath = NULL, $name = "", $location = "")
    {
        if (is_null($filepath))
        {
            return false;
        }
        
        $command = "Insert Request=" . $filepath . "|" . $_SERVER["REMOTE_ADDR"];
        if ($name || $location)
        {
            $command .= '|' . $name . '|' . $location;
        }
        
        // To be continued (Need to check the output of doQuery)
        
        return ($this->doQuery($command) == "Thank you! Your request has been submitted.") ? true : false;
    }
    
    public function setIp($server_ip)
    {
        $this->server_ip = $server_ip;
        return true;
    }
    
    public function setPort($server_port)
    {
        $this->server_port = $server_port;
        return true;
    }
    
    private function doQuery($command = NULL, $multi = false)
    {
    
        if (!is_null($command) && !empty($command))
        {
            $data = array();
            $command = rawurldecode($command);
            if (get_magic_quotes_gpc ())
            {
                $command = stripslashes ($command);
            }
            $command .= "\r\n"; // Adding the vital NewLine to the given command
            $fp = fsockopen($this->server_ip, intval($this->server_port), $errno, $errstr, 10);
            if ($fp !== false)
            {
                fwrite($fp, $command);
                $buffer = trim(fgets($fp));
                if($multi === true || is_string($multi))
                {
                    $stopmsg = is_string($multi) ? $multi : "OK";
                    while (!empty($buffer) && ($buffer != $stopmsg))
                    {
                        $data[] = $buffer;
                        $buffer = trim(fgets($fp));
                    }
                }
                else
                {
                    $data = $buffer;
                }
                fclose($fp);
            }
            else
            {
                throw new SPLRequestException('SPLRequest Error\r\n' . $errno . ': ' . $errstr . '\r\n');
            }
        }
        else
        {
            throw new SPLRequestException('No valid command given.');
        }
        
        return !empty($data) ? $data : false;
    }
    
}

/**
 * An exception generated by SPLRequest.
 */
class SPLRequestException extends \Exception
{
}